# Grant read access to FHIR resources belonging to a particular study(ies)
# if the client has the study_id(s) in its read-study list of IDs
# FHIR resources belong to a study if they have the study_id in their tag list
# (e.g. Patient.meta.tags.0.code=<study_id>)

id: read-study-policy
resourceType: AccessPolicy
link:
  - id: ingest_client
    resourceType: Client
engine: complex
and:
  # Check 1 - URI, request method
  - engine: matcho
    matcho:
      uri: '#\/fhir\/.*'
      client:
        details:
          read-study: present?
      params:
        _tag: .client.details.read-study
      request-method: get
  # Check 2 - Resource belongs to study Client has read access to
  - engine: sql
    sql:
      query: |
        select true from patient limit 1;
